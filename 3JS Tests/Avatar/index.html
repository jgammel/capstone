<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>Load Avatar - glTF version</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>
		<script src="../libraries/three.js-master/build/three.js"></script>
		<!--Must include objecct loader. GLTF is preferred-->
		<script src="../libraries/three.js-master/examples/js/loaders/GLTFLoader.js"></script>
		<script src="../libraries/dat-gui/build/dat.gui.js"></script>
		<script src="../libraries/three.js-master/examples/js/WebGL.js"></script>
		<script>
			//Check to see if Browser supports WebGL
			if ( WEBGL.isWebGLAvailable() === false ) {
				document.body.appendChild( WEBGL.getWebGLErrorMessage() );
			}
			var container;
			var camera, scene, renderer, root_scene;
			var mouseX = 0, mouseY = 0;
			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;
			var object;

			//init renders the scene
			init();

			function init() {
				//create the container that will house the renderer later on
				container = document.createElement( 'div' );
				document.body.appendChild( container );

				// scene, background, fog, etc.
				//should be first so we can add stuff to it later
				scene = new THREE.Scene();
				scene.fog = new THREE.Fog( 0xe0e0e0, 20, 100 );

				//set up camera and helper
				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 1000 );
				camera.position.set( 0, 0, 2 );
				var camera_helper = new THREE.CameraHelper( camera );
				//add cameras
				scene.add( camera );
				scene.add( camera_helper );

				
				//lights
				var ambientLight = new THREE.AmbientLight( 0xf3f3f3, 0.9 );//ambient lights light a scene uniformly and cannot be used to cast shadow as they do not have any direction
				scene.add( ambientLight );

				var directionalLight = new THREE.DirectionalLight( 0xffffff, 0.5 );
				directionalLight.setPosition = new THREE.Vector3(5,5,0);
				scene.add( directionalLight );
				

				//model loader
				// Instantiate a loader
				var loader = new THREE.GLTFLoader(); 
				
				//this type of file loading only works when running a local server. Currently using MAMP
				loader.load('glb/T-Pose-with-skeleton.gltf',
				function(gltf){

					//this object contains bones, skinnedmesh
					model = gltf.scene;
					scene.add(model);

					//add a skeleton helper to visualize and access bones
					skeleton_helper = new THREE.SkeletonHelper( model );
					skeleton_helper.visible = true;
					scene.add( skeleton_helper );

					

					console.log("called when the resource is loaded");

					//animate animates frames in a loop
					animate();
					initGUI();
				},
				function(xhr){
					console.log("called while loading is progressing");
					if ( xhr.lengthComputable ) {
						var percentComplete = xhr.loaded / xhr.total * 100;
						console.log( 'model ' + Math.round( percentComplete, 2 ) + '% downloaded' );
					}
				},
				function(error){
					console.log("called when loading has errors");
					console.log(error);
				});

				// some code for loading manager might go here?

				
				//renderer
				renderer = new THREE.WebGLRenderer();
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				//always configure renderer for GLTF this way, because glTF format uses sRGB color space
				renderer.gammaOutput = true;
				renderer.gammaFactor = 2.2;
				container.appendChild( renderer.domElement );
				//
				window.addEventListener( 'resize', onWindowResize, false );
			}
			
			function onWindowResize() {
				windowHalfX = window.innerWidth / 2;
				windowHalfY = window.innerHeight / 2;
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			}

			//
			function animate() {
				requestAnimationFrame( animate );
				model.rotation.y += 0.01;
				render();
			}
			
			function initGUI(){
				//init dat gui
				var gui = new dat.GUI();
				var text = new avatarEditor();

				//add the folders and inputs
				var f_general = gui.addFolder('General'); //incl. height
				var heightController = f_general.add(text, 'height').step(0.5).min(50).max(75);
				var initialPosSpine = skeleton_helper.bones[1].position.y;

				var f_shoulders = gui.addFolder('Shoulders'); //incl. across shoulder width
				var shoulderController = f_shoulders.add(text, 'shoulderWidth').step(0.5).min(10).max(20);

				var f_bust = gui.addFolder('Bust'); //incl. bust height and under bust circumference
				var bustController = f_bust.add(text, 'bustHeight').step(0.5).min(35).max(50);
				var underbustController = f_bust.add(text, 'underbustCircumference').step(0.5).min(20).max(35);

				var f_arms = gui.addFolder('Arms'); //incl. arm length, bicep circumference, elbow circumference, wrist circumference
				var armController = f_arms.add(text, 'armLength').step(0.5).min(15).max(30);
				var bicepController = f_arms.add(text, 'bicepCircumference').step(0.5).min(8).max(15);
				var wristController = f_arms.add(text, 'wristCircumference').step(0.5).min(3).max(7);

				var f_hips = gui.addFolder('Hips'); //include high hip circumference and low hip circumference
				var highHipController = f_hips.add(text, 'highHipCircumference').step(1).min(20).max(50);
				var lowHipController = f_hips.add(text, 'lowHipCircumference').step(1).min(20).max(50);

				var f_legs = gui.addFolder('Legs'); //include leg inseam height, thigh circumference, knee circumference, calf circumference, ankle circumference
				var initialPosRLeg = skeleton_helper.bones[49].position.y;
				var initialPosLLeg = skeleton_helper.bones[45].position.y;
				var inseamController = f_legs.add(text, 'legInseamHeight').step(0.5).min(20).max(40);
				var thighController = f_legs.add(text, 'thighCircumference').step(0.5).min(15).max(30);
				var kneeController = f_legs.add(text, 'kneeCircumference').step(0.5).min(10).max(15);
				var calfController = f_legs.add(text, 'calfCircumference').step(0.5).min(10).max(20);
				var ankleController = f_legs.add(text, 'ankleCircumference').step(0.5).min(5).max(10);

				//manipulate bones
				//update Height
				heightController.onChange(function(value) {
					var change = (value - heightController.initialValue) / 100;
					console.log(skeleton_helper.bones);
					skeleton_helper.bones[1].position.y = initialPosSpine + (change * 0.5);
					skeleton_helper.bones[49].position.y = initialPosRLeg + (change * 0.4);
					skeleton_helper.bones[45].position.y = initialPosLLeg + (change * 0.4);

				});
			}


			var avatarEditor = function(){
				this.height = 66;
				this.shoulderWidth = 14.5;
				this.bustHeight = 48;
				this.underbustCircumference = 27;
				this.armLength = 22;
				this.bicepCircumference = 10;
				this.wristCircumference = 5.5;
				this.highHipCircumference = 32.5;
				this.lowHipCircumference = 36.5;
				this.legInseamHeight = 31.5;
				this.thighCircumference = 21.5;
				this.kneeCircumference = 13;
				this.calfCircumference = 13;
				this.ankleCircumference = 8;
			};

			function render() {
				renderer.render( scene, camera );
			}
		</script>
	</body>
</html>